<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tetris Games Intecap</title>
    <!-- 
      p5.js es una biblioteca JavaScript que facilita la creaci√≥n de gr√°ficos y animaciones
      en el navegador. Se utiliza para el manejo del canvas y la l√≥gica del juego.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
  </head>
  <body>
    <!-- 
      Estilos CSS para el dise√±o de la p√°gina
      Se utiliza Flexbox para centrar el canvas y crear un fondo degradado
    -->
    <style>
      /*
        =============================
        CSS PRINCIPAL PARA TETRIS JS
        =============================
        Este CSS controla el dise√±o responsivo, el fondo animado, el canvas y los botones de UI.
        Cada secci√≥n est√° comentada para facilitar la comprensi√≥n y personalizaci√≥n.
      */

      /*
        El html y el body ocupan toda la pantalla y no permiten scroll.
        Esto asegura que el juego y el fondo siempre llenen el viewport.
      */
      html,
      body {
        height: 100%; /* Ocupa el 100% de la altura de la ventana */
        width: 100%; /* Ocupa el 100% del ancho de la ventana */
        margin: 0; /* Elimina m√°rgenes por defecto */
        padding: 0; /* Elimina padding por defecto */
        overflow: hidden !important; /* Bloquea cualquier scroll */
        box-sizing: border-box; /* Incluye el padding y border en el tama√±o total */
      }

      /*
        BODY: Centra el canvas usando Flexbox y aplica el fondo animado.
        - justify-content y align-items centran el contenido.
        - height y width aseguran que el fondo cubra toda la pantalla.
        - background y animation crean el degradado animado.
        - position: relative permite usar ::before y ::after para las estrellas.
        - overflow: hidden asegura que nada se salga del viewport.
      */
      body {
        display: flex; /* Flexbox para centrar el canvas */
        justify-content: center; /* Centra horizontalmente */
        align-items: center; /* Centra verticalmente */
        height: 100vh; /* 100% de la altura de la ventana */
        width: 100vw; /* 100% del ancho de la ventana */
        background: linear-gradient(
          135deg,
          #0f0f23 0%,
          #1a1a2e 25%,
          #16213e 50%,
          #0f3460 75%,
          #533483 100%
        ); /* Degradado de fondo */
        background-size: 400% 400%; /* Tama√±o grande para animaci√≥n */
        animation: gradient 15s ease infinite; /* Anima el fondo */
        position: relative; /* Para usar ::before y ::after */
        overflow: hidden !important; /* Bloquea scroll extra */
      }

      /*
        =============================
        FONDO ANIMADO DE ESTRELLAS
        =============================
        Se usan ::before y ::after para crear dos capas de estrellas animadas.
        Cada capa tiene diferentes posiciones, tama√±os y animaciones para dar profundidad.
      */

      /* Primera capa de estrellas (m√°s brillante y r√°pida) */
      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* Varias estrellas de diferentes tama√±os y colores */
        background-image: 
          /* Estrellas peque√±as que destellan */ radial-gradient(
            1px 1px at 20px 30px,
            #fff,
            transparent
          ),
          radial-gradient(1px 1px at 40px 70px, #fff, transparent),
          radial-gradient(1px 1px at 90px 40px, #fff, transparent),
          radial-gradient(1px 1px at 130px 80px, #fff, transparent),
          radial-gradient(1px 1px at 160px 30px, #fff, transparent),
          radial-gradient(1px 1px at 200px 60px, #fff, transparent),
          radial-gradient(1px 1px at 250px 20px, #fff, transparent),
          radial-gradient(1px 1px at 300px 90px, #fff, transparent),
          radial-gradient(1px 1px at 350px 50px, #fff, transparent),
          radial-gradient(1px 1px at 400px 10px, #fff, transparent),
          radial-gradient(1px 1px at 450px 80px, #fff, transparent),
          radial-gradient(1px 1px at 500px 30px, #fff, transparent),
          radial-gradient(1px 1px at 550px 70px, #fff, transparent),
          radial-gradient(1px 1px at 600px 15px, #fff, transparent),
          radial-gradient(1px 1px at 650px 85px, #fff, transparent),
          radial-gradient(1px 1px at 700px 45px, #fff, transparent),
          radial-gradient(1px 1px at 750px 25px, #fff, transparent),
          radial-gradient(1px 1px at 800px 75px, #fff, transparent),
          radial-gradient(1px 1px at 850px 35px, #fff, transparent),
          radial-gradient(1px 1px at 900px 65px, #fff, transparent),
          /* Estrellas medianas con destellos */
            radial-gradient(2px 2px at 50px 120px, #fff, transparent),
          radial-gradient(2px 2px at 150px 180px, #fff, transparent),
          radial-gradient(2px 2px at 250px 140px, #fff, transparent),
          radial-gradient(2px 2px at 350px 200px, #fff, transparent),
          radial-gradient(2px 2px at 450px 160px, #fff, transparent),
          radial-gradient(2px 2px at 550px 220px, #fff, transparent),
          radial-gradient(2px 2px at 650px 180px, #fff, transparent),
          radial-gradient(2px 2px at 750px 240px, #fff, transparent),
          /* Estrellas grandes brillantes */
            radial-gradient(3px 3px at 100px 300px, #fff, transparent),
          radial-gradient(3px 3px at 300px 350px, #fff, transparent),
          radial-gradient(3px 3px at 500px 320px, #fff, transparent),
          radial-gradient(3px 3px at 700px 380px, #fff, transparent),
          /* Estrellas de colores */
            radial-gradient(1.5px 1.5px at 120px 150px, #00ffff, transparent),
          radial-gradient(1.5px 1.5px at 320px 250px, #ff69b4, transparent),
          radial-gradient(1.5px 1.5px at 520px 180px, #ffff00, transparent),
          radial-gradient(1.5px 1.5px at 720px 280px, #00ff00, transparent);
        background-repeat: repeat;
        background-size: 100vw 40vh;
        animation: starTwinkle 4s ease-in-out infinite;
        opacity: 0.8;
      }

      /* Segunda capa de estrellas (m√°s suave y lenta, para profundidad) */
      body::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* M√°s estrellas, diferentes posiciones */
        background-image: radial-gradient(
            1px 1px at 30px 50px,
            #fff,
            transparent
          ),
          radial-gradient(1px 1px at 80px 100px, #fff, transparent),
          radial-gradient(1px 1px at 130px 150px, #fff, transparent),
          radial-gradient(1px 1px at 180px 200px, #fff, transparent),
          radial-gradient(1px 1px at 230px 250px, #fff, transparent),
          radial-gradient(1px 1px at 280px 300px, #fff, transparent),
          radial-gradient(1px 1px at 330px 350px, #fff, transparent),
          radial-gradient(1px 1px at 380px 400px, #fff, transparent),
          radial-gradient(1px 1px at 430px 450px, #fff, transparent),
          radial-gradient(1px 1px at 480px 500px, #fff, transparent),
          radial-gradient(1px 1px at 530px 550px, #fff, transparent),
          radial-gradient(1px 1px at 580px 600px, #fff, transparent),
          radial-gradient(1px 1px at 630px 650px, #fff, transparent),
          radial-gradient(1px 1px at 680px 700px, #fff, transparent),
          radial-gradient(1px 1px at 730px 750px, #fff, transparent),
          radial-gradient(1px 1px at 780px 800px, #fff, transparent),
          radial-gradient(1px 1px at 830px 850px, #fff, transparent),
          radial-gradient(1px 1px at 880px 900px, #fff, transparent),
          radial-gradient(1px 1px at 930px 950px, #fff, transparent),
          radial-gradient(1px 1px at 980px 1000px, #fff, transparent);
        background-repeat: repeat;
        background-size: 100vw 100vh;
        animation: starTwinkle 6s ease-in-out infinite reverse;
        opacity: 0.6;
      }

      /*
        Animaci√≥n de parpadeo de las estrellas.
        Cambia la opacidad y el tama√±o para simular destellos.
      */
      @keyframes starTwinkle {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(0.8);
        }
        25% {
          opacity: 0.8;
          transform: scale(1.2);
        }
        50% {
          opacity: 1;
          transform: scale(1.5);
        }
        75% {
          opacity: 0.6;
          transform: scale(1.1);
        }
      }

      /*
        Animaci√≥n del degradado de fondo.
        Mueve el fondo para dar sensaci√≥n de movimiento.
      */
      @keyframes gradient {
        0% {
          background-position: 0% 50%;
        }
        25% {
          background-position: 100% 50%;
        }
        50% {
          background-position: 100% 100%;
        }
        75% {
          background-position: 0% 100%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      /*
        =============================
        CANVAS DEL JUEGO
        =============================
        El canvas tiene sombra, borde y fondo transl√∫cido para resaltar el √°rea de juego.
        El filtro drop-shadow da profundidad visual.
      */
      canvas {
        filter: drop-shadow(0px 0px 20px rgba(0, 255, 255, 0.3))
          drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.6)); /* Sombra doble */
        display: block;
        border-radius: 10px; /* Bordes redondeados */
        border: 2px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
        background: rgba(0, 0, 0, 0.2); /* Fondo transl√∫cido */
        backdrop-filter: blur(5px); /* Difumina el fondo detr√°s del canvas */
        position: relative;
        z-index: 10; /* Sobre el fondo, debajo de los botones */
      }

      /*
        Efecto de brillo animado en los bordes del canvas.
        Usa un gradiente animado para dar un efecto de ne√≥n.
      */
      canvas::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(
          45deg,
          #00ffff,
          #ff00ff,
          #ffff00,
          #00ff00,
          #00ffff
        );
        background-size: 400% 400%;
        border-radius: 12px;
        z-index: -1;
        animation: borderGlow 3s ease-in-out infinite;
      }

      /*
        Animaci√≥n del brillo de los bordes del canvas.
      */
      @keyframes borderGlow {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      /*
        =============================
        BOTONES DE UI (SONIDO Y M√öSICA)
        =============================
        Los botones est√°n en una capa fija (#uiLayer) para que no se vean afectados por el fondo.
        .ui-btn define el estilo visual y la interacci√≥n.
        Media queries los hacen m√°s peque√±os en m√≥viles.
      */
      #uiLayer {
        position: fixed; /* Siempre en la misma posici√≥n en pantalla */
        top: 0;
        right: 0;
        width: auto;
        z-index: 2000; /* Sobre el canvas y el fondo */
        pointer-events: none; /* Solo los hijos reciben eventos */
      }
      /* Botones de UI */
      .ui-btn {
        position: relative; /* Para stacking context */
        margin: 20px 20px 0 0; /* Separaci√≥n de los bordes */
        background: rgba(0, 0, 0, 0.7); /* Fondo oscuro transl√∫cido */
        color: white; /* Texto blanco */
        padding: 12px 18px; /* Espaciado interno */
        border-radius: 8px; /* Bordes redondeados */
        font-family: Arial, sans-serif;
        font-size: 18px;
        z-index: 2100; /* Sobre el fondo y el canvas */
        cursor: pointer; /* Cursor de mano */
        pointer-events: auto; /* Permite clicks */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); /* Sombra sutil */
        user-select: none; /* No permite seleccionar el texto */
        transition: background 0.2s, transform 0.2s; /* Animaci√≥n al presionar */
      }
      .ui-btn:active {
        background: rgba(0, 0, 0, 0.9); /* M√°s oscuro al presionar */
        transform: scale(0.97); /* Efecto de presi√≥n */
      }
      /* Responsive para m√≥viles: botones m√°s peque√±os y menos margen */
      @media (max-width: 600px) {
        .ui-btn {
          font-size: 15px;
          padding: 10px 12px;
          margin: 12px 12px 0 0;
        }
        #uiLayer {
          right: 0;
          top: 0;
        }
      }
      @media (max-width: 400px) {
        .ui-btn {
          font-size: 13px;
          padding: 8px 8px;
          margin: 8px 8px 0 0;
        }
      }
    </style>

    <!-- 
      Definici√≥n de constantes globales
      Estas constantes afectan el comportamiento y apariencia del juego
    -->
    <script>
      // Margen del tablero en p√≠xeles para dar espacio alrededor del √°rea de juego
      const MARGE_TABLERO = 10;
    </script>

    <!-- 
      Inclusi√≥n de los archivos JavaScript necesarios
      Tablero.js: Maneja la l√≥gica del tablero de juego
      Tetrimino.js: Maneja la l√≥gica de las piezas del Tetris
    -->
    <script src="Tablero.js"></script>
    <script src="Tetrimino.js"></script>

    <!-- Sistema de Audio para el juego -->
    <audio id="moveSound" preload="auto"></audio>
    <audio id="rotateSound" preload="auto"></audio>
    <audio id="dropSound" preload="auto"></audio>
    <audio id="lineClearSound" preload="auto"></audio>
    <audio id="tetrisSound" preload="auto"></audio>
    <audio id="gameOverSound" preload="auto"></audio>

    <!-- M√∫sica de fondo de Tetris -->
    <audio id="tetrisMusic" preload="auto" loop>
      <!-- Aqu√≠ puedes agregar tu archivo MP3 de Tetris -->
      <!-- <source src="tetris_theme.mp3" type="audio/mpeg"> -->
    </audio>

    <!-- Capa de UI para botones -->
    <div id="uiLayer">
      <!-- Bot√≥n para activar/desactivar sonido -->
      <div id="soundToggle" class="ui-btn">üîä Sonido: ON</div>
      <!-- Bot√≥n para activar/desactivar m√∫sica -->
      <div id="musicToggle" class="ui-btn">üéµ M√∫sica: ON</div>
    </div>

    <script>
      /**
       * TETRIS JS - Juego cl√°sico de Tetris hecho con p5.js
       *
       * Estructura principal:
       * - Tablero.js: L√≥gica del tablero y almacenamiento de piezas.
       * - Tetrimino.js: L√≥gica de las piezas (tetriminos), movimiento y rotaci√≥n.
       * - index.html: Interfaz, controles, audio y ciclo principal del juego.
       *
       * Controles:
       * - Flechas ‚Üê ‚Üí ‚Üì: Mover la pieza
       * - Flecha ‚Üë: Rotar la pieza
       * - Espacio: Ca√≠da instant√°nea
       *
       * El juego inicia con una pantalla de bienvenida. Presiona ENTER para comenzar.
       *
       * Si eres principiante, sigue los comentarios en cada funci√≥n para entender el flujo.
       */
      /**
       * Variables globales del juego
       * Estas variables controlan el estado y comportamiento del juego
       */
      let regulador_velocidad_teclas = 0; // Controla la velocidad de respuesta de las teclas
      let regulador_de_caida = 0; // Controla la velocidad de ca√≠da de las piezas
      let lineas_hechas = 0; // Contador de l√≠neas completadas
      let velocidad_caida = 500; // Velocidad inicial de ca√≠da en milisegundos

      // =============================
      // Pantalla de inicio
      // =============================
      // Variable global para controlar si estamos en la pantalla de inicio
      let enPantallaInicio = true;

      /**
       * Sistema de Audio
       * Variables y funciones para manejar los sonidos del juego
       */
      let sonidoActivado = true; // Controla si el sonido est√° activado
      let volumenSonido = 0.3; // Volumen general del juego (0.0 a 1.0)
      let audioContext; // Contexto de Web Audio API
      let musicaActivada = true; // Controla si la m√∫sica de fondo est√° activada

      /**
       * Genera un sonido sint√©tico usando Web Audio API
       * @param {string} tipo - Tipo de sonido a generar
       * @param {number} frecuencia - Frecuencia base del sonido
       * @param {number} duracion - Duraci√≥n en segundos
       */
      function generarSonido(tipo, frecuencia = 440, duracion = 0.1) {
        if (!sonidoActivado || !audioContext) return;

        const oscilador = audioContext.createOscillator();
        const ganancia = audioContext.createGain();

        oscilador.connect(ganancia);
        ganancia.connect(audioContext.destination);

        // Configurar el tipo de onda seg√∫n el sonido
        switch (tipo) {
          case "move":
            oscilador.type = "sine";
            frecuencia = 800;
            duracion = 0.05;
            break;
          case "rotate":
            oscilador.type = "square";
            frecuencia = 600;
            duracion = 0.08;
            break;
          case "drop":
            oscilador.type = "sawtooth";
            frecuencia = 300;
            duracion = 0.15;
            break;
          case "lineClear":
            oscilador.type = "sine";
            frecuencia = 800;
            duracion = 0.2;
            break;
          case "tetris":
            oscilador.type = "sine";
            frecuencia = 1000;
            duracion = 0.3;
            break;
          case "gameOver":
            oscilador.type = "sawtooth";
            frecuencia = 200;
            duracion = 0.5;
            break;
        }

        oscilador.frequency.setValueAtTime(
          frecuencia,
          audioContext.currentTime
        );

        // Configurar envolvente de volumen
        ganancia.gain.setValueAtTime(0, audioContext.currentTime);
        ganancia.gain.linearRampToValueAtTime(
          volumenSonido * 0.3,
          audioContext.currentTime + 0.01
        );
        ganancia.gain.exponentialRampToValueAtTime(
          0.001,
          audioContext.currentTime + duracion
        );

        // Sonidos especiales
        if (tipo === "tetris") {
          // Melod√≠a ascendente para Tetris
          oscilador.frequency.setValueAtTime(800, audioContext.currentTime);
          oscilador.frequency.linearRampToValueAtTime(
            1200,
            audioContext.currentTime + 0.1
          );
          oscilador.frequency.linearRampToValueAtTime(
            1600,
            audioContext.currentTime + 0.2
          );
        } else if (tipo === "gameOver") {
          // Melod√≠a descendente para Game Over
          oscilador.frequency.setValueAtTime(400, audioContext.currentTime);
          oscilador.frequency.linearRampToValueAtTime(
            300,
            audioContext.currentTime + 0.1
          );
          oscilador.frequency.linearRampToValueAtTime(
            200,
            audioContext.currentTime + 0.2
          );
          oscilador.frequency.linearRampToValueAtTime(
            100,
            audioContext.currentTime + 0.3
          );
        } else if (tipo === "lineClear") {
          // Melod√≠a ascendente r√°pida
          oscilador.frequency.setValueAtTime(600, audioContext.currentTime);
          oscilador.frequency.linearRampToValueAtTime(
            800,
            audioContext.currentTime + 0.1
          );
        }

        oscilador.start(audioContext.currentTime);
        oscilador.stop(audioContext.currentTime + duracion);
      }

      /**
       * Funci√≥n para reproducir sonidos
       * @param {string} tipoSonido - Tipo de sonido a reproducir
       */
      function reproducirSonido(tipoSonido) {
        if (!sonidoActivado) return;

        // Usar Web Audio API para sonidos sint√©ticos
        generarSonido(tipoSonido);
      }

      /**
       * Funci√≥n para alternar el sonido on/off
       */
      function alternarSonido() {
        sonidoActivado = !sonidoActivado;
        const botonSonido = document.getElementById("soundToggle");
        if (botonSonido) {
          botonSonido.innerHTML = sonidoActivado
            ? "üîä Sonido: ON"
            : "üîá Sonido: OFF";
        }
      }

      /**
       * Carga un archivo de m√∫sica MP3
       * @param {string} url - URL del archivo MP3
       */
      function cargarMusica(url) {
        const audio = document.getElementById("tetrisMusic");
        if (audio) {
          audio.src = url;
          audio.volume = 0.3; // Volumen al 30%
          audio.load();
          console.log("üéµ M√∫sica cargada:", url);
        }
      }

      /**
       * Reproduce la m√∫sica de fondo
       */
      function reproducirMusica() {
        const audio = document.getElementById("tetrisMusic");
        if (audio && musicaActivada) {
          audio
            .play()
            .catch((e) => console.log("Error reproduciendo m√∫sica:", e));
        }
      }

      /**
       * Pausa la m√∫sica de fondo
       */
      function pausarMusica() {
        const audio = document.getElementById("tetrisMusic");
        if (audio) {
          audio.pause();
        }
      }

      /**
       * Funci√≥n para alternar la m√∫sica de fondo
       */
      function alternarMusica() {
        musicaActivada = !musicaActivada;
        const botonMusica = document.getElementById("musicToggle");
        if (botonMusica) {
          botonMusica.innerHTML = musicaActivada
            ? "üéµ M√∫sica: ON"
            : "üîá M√∫sica: OFF";
        }

        const audio = document.getElementById("tetrisMusic");
        if (audio) {
          if (musicaActivada) {
            audio
              .play()
              .catch((e) => console.log("Error reproduciendo m√∫sica:", e));
          } else {
            audio.pause();
          }
        }
      }

      /**
       * Sistema de ca√≠da autom√°tica
       * Controla la velocidad de ca√≠da de las piezas
       * La velocidad aumenta gradualmente para aumentar la dificultad
       * @function caidaAutomatica
       */
      function caidaAutomatica() {
        if (millis() - regulador_de_caida > velocidad_caida) {
          regulador_de_caida = millis();
          tetrimino.moverAbajo();
          tetrimino.espectro.actualizar();
        }
      }

      /**
       * Funci√≥n setup de p5.js
       * Se ejecuta una vez al inicio del juego
       * Inicializa el canvas y las variables globales
       * Define la configuraci√≥n inicial del juego
       */
      function setup() {
        // Calcular el tama√±o m√°ximo disponible para el canvas
        let maxAncho = min(windowWidth * 0.98, 900);
        let maxAlto = min(windowHeight * 0.98, 600);
        // Calcular el tama√±o de celda para que el tablero quepa en el canvas
        let lado_celda = Math.floor(
          min(
            (maxAncho - 2 * MARGE_TABLERO) / 10,
            (maxAlto - 2 * MARGE_TABLERO - 2 * 25) / 20
          )
        );
        if (lado_celda < 10) lado_celda = 10; // tama√±o m√≠nimo
        let anchoCanvas = lado_celda * 10 + 2 * MARGE_TABLERO;
        let altoCanvas = lado_celda * 20 + 2 * MARGE_TABLERO + 2 * lado_celda;
        createCanvas(anchoCanvas, altoCanvas);

        /**
         * Definici√≥n del mapeo base de tetriminos
         * Cada tetrimino tiene:
         * - color: Color de la pieza
         * - mapa: Array de vectores que define la forma de la pieza
         * Los vectores se crean usando createVector() de p5.js
         */
        tetriminosBase = {
          Z: {
            color: "red",
            mapa: [
              createVector(),
              createVector(-1, -1),
              createVector(0, -1),
              createVector(1, 0),
            ],
          },
          S: {
            color: "lime",
            mapa: [
              createVector(),
              createVector(1, -1),
              createVector(0, -1),
              createVector(-1, 0),
            ],
          },
          J: {
            color: "orange",
            mapa: [
              createVector(),
              createVector(-1, 0),
              createVector(-1, -1),
              createVector(1, 0),
            ],
          },
          L: {
            color: "dodgerblue",
            mapa: [
              createVector(),
              createVector(-1, 0),
              createVector(1, -1),
              createVector(1, 0),
            ],
          },
          T: {
            color: "magenta",
            mapa: [
              createVector(),
              createVector(-1, 0),
              createVector(1, 0),
              createVector(0, -1),
            ],
          },
          O: {
            color: "yellow",
            mapa: [
              createVector(),
              createVector(0, -1),
              createVector(1, -1),
              createVector(1, 0),
            ],
          },
          I: {
            color: "cyan",
            mapa: [
              createVector(),
              createVector(-1, 0),
              createVector(1, 0),
              createVector(2, 0),
            ],
          },
        };

        // Inicializaci√≥n de variables globales
        // Importante: No usar let ni var para mantener el alcance global
        tablero = new Tablero(lado_celda);
        tetrimino = new Tetrimino();
        resizeCanvas(
          tablero.ancho + 2 * MARGE_TABLERO,
          tablero.alto + 2 * MARGE_TABLERO + 2 * tablero.lado_celda
        );
        inicializarAudio();
      }

      /**
       * Funci√≥n draw de p5.js
       * Se ejecuta continuamente para actualizar y dibujar el juego
       * Esta funci√≥n es el bucle principal del juego
       */
      function draw() {
        clear();
        // =============================
        // Mostrar pantalla de inicio si corresponde
        // =============================
        if (enPantallaInicio) {
          mostrarPantallaInicio();
          return; // No ejecutar la l√≥gica del juego hasta que se presione ENTER
        }
        caidaAutomatica();
        dibujarPuntaje();
        tablero.dibujar();
        tetrimino.dibujar();
        keyEventsTetris();
      }

      /**
       * Dibuja el puntaje en la parte superior del canvas
       * Muestra el n√∫mero de l√≠neas completadas
       * Utiliza el sistema de coordenadas de p5.js
       */
      function dibujarPuntaje() {
        push();
        textSize(20);
        strokeWeight(2);
        stroke("black");
        fill("white");
        text(
          "Lineas:" + lineas_hechas,
          tablero.posicion.x,
          tablero.posicion.y - tablero.lado_celda / 2
        );
        pop();
      }

      // L√≠mite de velocidad para el control de teclas (en milisegundos)
      let limite_regulador_velocidad_teclas = 100;

      /**
       * Maneja los eventos de teclado del juego
       * Controla el movimiento y rotaci√≥n de las piezas
       * Implementa diferentes velocidades para cada acci√≥n
       * Teclas utilizadas:
       * - Flecha izquierda: Mover pieza a la izquierda
       * - Flecha derecha: Mover pieza a la derecha
       * - Flecha abajo: Acelerar ca√≠da
       * - Flecha arriba: Rotar pieza
       * - Espacio: Ca√≠da instant√°nea
       */
      function keyEventsTetris() {
        if (
          millis() - regulador_velocidad_teclas <
          limite_regulador_velocidad_teclas
        ) {
          return;
        }
        limite_regulador_velocidad_teclas = 100;
        regulador_velocidad_teclas = millis();

        // Movimiento izquierda
        if (keyIsDown(LEFT_ARROW)) {
          tetrimino.moverIzquierda();
          reproducirSonido("move");
          //regulador_de_caida = millis();
        }
        // Movimiento derecha
        if (keyIsDown(RIGHT_ARROW)) {
          tetrimino.moverDerecha();
          reproducirSonido("move");
          //regulador_de_caida = millis();
        }
        // Movimiento abajo (ca√≠da r√°pida)
        if (keyIsDown(DOWN_ARROW)) {
          tetrimino.moverAbajo();
          reproducirSonido("drop");
          regulador_de_caida = millis();
        }
        // Rotaci√≥n de la pieza
        if (keyIsDown(UP_ARROW)) {
          limite_regulador_velocidad_teclas = 150;
          tetrimino.girar();
          reproducirSonido("rotate");
          //regulador_de_caida = millis();
        }
        // Ca√≠da instant√°nea (espacio)
        if (keyIsDown(32)) {
          limite_regulador_velocidad_teclas = 200;
          tetrimino.ponerEnElFondo();
          reproducirSonido("drop");
          regulador_de_caida = millis();
        }
      }

      /**
       * Inicializaci√≥n del sistema de audio
       */
      function inicializarAudio() {
        // Configurar el bot√≥n de sonido
        const botonSonido = document.getElementById("soundToggle");
        if (botonSonido) {
          botonSonido.addEventListener("click", alternarSonido);
        }

        // Configurar el bot√≥n de m√∫sica
        const botonMusica = document.getElementById("musicToggle");
        if (botonMusica) {
          botonMusica.addEventListener("click", alternarMusica);
        }

        // Inicializar Web Audio API para efectos de sonido
        try {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          console.log("Sistema de efectos de sonido inicializado");
        } catch (e) {
          console.log("Error inicializando audio:", e);
          sonidoActivado = false;
        }

        // Cargar m√∫sica de fondo
        cargarMusica("/music/tetris_theme.mp3");
        // NO reproducir aqu√≠ directamente

        // Funci√≥n para activar el contexto de audio y la m√∫sica en la primera interacci√≥n
        function activarAudioYMusica() {
          if (audioContext && audioContext.state === "suspended") {
            audioContext.resume();
            console.log("Audio activado por interacci√≥n del usuario");
          }
          reproducirMusica();
          // Remover el evento despu√©s de la primera activaci√≥n
          document.removeEventListener("click", activarAudioYMusica);
          document.removeEventListener("keydown", activarAudioYMusica);
        }

        // Agregar eventos para activar el audio y la m√∫sica en la primera interacci√≥n
        document.addEventListener("click", activarAudioYMusica);
        document.addEventListener("keydown", activarAudioYMusica);
      }

      /**
       * Dibuja la pantalla de inicio del juego
       * Muestra el t√≠tulo, instrucciones y espera que el usuario presione ENTER
       */
      function mostrarPantallaInicio() {
        push();
        background(0, 0, 0, 180); // Fondo semitransparente para resaltar el mensaje
        textAlign(CENTER, CENTER);
        textSize(48);
        fill("white");
        stroke("black");
        strokeWeight(4);
        text("TETRIS", width / 2, height / 2 - 60);
        textSize(24);
        noStroke();
        text("Presiona ENTER", width / 2, height / 2 + 10);
        text("para comenzar", width / 2, height / 2 + 40);
        textSize(16);
        text("Controles: ‚Üê ‚Üí ‚Üì ‚Üë y Espacio", width / 2, height / 2 + 70);
        pop();
      }

      // =============================
      // Evento para iniciar el juego desde la pantalla de inicio
      // =============================
      /**
       * p5.js llama autom√°ticamente a esta funci√≥n cuando se presiona una tecla
       * Si estamos en la pantalla de inicio y se presiona ENTER, comienza el juego
       */
      function keyPressed() {
        if (enPantallaInicio && keyCode === ENTER) {
          enPantallaInicio = false;
        }
      }

      // Hacer el canvas responsivo al cambiar el tama√±o de la ventana
      function windowResized() {
        setup();
      }
    </script>
  </body>
</html>